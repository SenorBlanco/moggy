<!doctype html>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<html>
<head>
<title>Moggy, the Interweb Transmogrifier</title>
</head>
<svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" version="1.1" color-interpolation-filters="sRGB" id="svgDoc">
  <defs>
    <filter id="f1"></filter>
  </defs>
</svg>
<video autoplay loop style="-webkit-filter: url(#f1); filter: url(#f1); position: absolute;">
<source src="octopus.mp4" type="video/mp4"></source>
<source src="octopus.ogv" type="video/ogg"></source>
</video>
<canvas width="600" height="800" id="schemCanvas" style="position: absolute; right: 0px;"></canvas>
<form id="form" style="position: absolute; bottom: 0px;"></form>
<script src="schematic.js" type="text/javascript"></script>
<script>
var f1 = document.getElementById("f1");
var form = document.getElementById("form");
var canvas = document.getElementById("schemCanvas");
var ctx = canvas.getContext("2d");
var schematic = new Schematic(canvas.width, canvas.height);
var svgns = "http://www.w3.org/2000/svg";
canvas.onmousemove = function(event) {
    event.preventDefault();
    schematic.onMouseMove(event.pageX - canvas.offsetLeft,
                          event.pageY - canvas.offsetTop);
};
canvas.onmousedown = function(event) {
    event.preventDefault();
    schematic.onMouseDown(event.pageX - canvas.offsetLeft,
                          event.pageY - canvas.offsetTop);
};
canvas.onmouseup = function(event) {
    event.preventDefault();
    schematic.onMouseUp(event.pageX - canvas.offsetLeft,
                        event.pageY - canvas.offsetTop);
};
var lastTouch;
canvas.addEventListener('touchmove', function(event) {
  if (event.targetTouches.length == 1) {
    event.preventDefault();
    lastTouch = event.targetTouches[0];
    schematic.onMouseMove(lastTouch.pageX - canvas.offsetLeft,
                          lastTouch.pageY - canvas.offsetTop);
  }
});
canvas.addEventListener('touchstart', function(event) {
  if (event.targetTouches.length == 1) {
    event.preventDefault();
    lastTouch = event.targetTouches[0];
    schematic.onMouseDown(lastTouch.pageX - canvas.offsetLeft,
                          lastTouch.pageY - canvas.offsetTop);
  }
});
canvas.addEventListener('touchend', function(event) {
  event.preventDefault();
  schematic.onMouseUp(lastTouch.pageX - canvas.offsetLeft,
                      lastTouch.pageY - canvas.offsetTop);
});
window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame    ||
          function( callback ){
            window.setTimeout(callback, 1000 / 60);
          };
})();
schematic.onInvalidate = function() {
    requestAnimFrame(function() {
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        schematic.draw(ctx);
    });
};

function createRangeUI(text, min, max, value, step) {
    var input = document.createElement("input");
    input.type = "range";
    input.min = min;
    input.max = max;
    input.step = step;
    input.value = value;
    form.appendChild(input);
    var label = document.createElement("span");
    label.innerHTML = text;
    form.appendChild(label);
    return input;
}

function createColorPickerUI(text, value) {
    var input = document.createElement("input");
    input.type = "color";
    input.value = value;
    form.appendChild(input);
    var label = document.createElement("span");
    label.innerHTML = text;
    form.appendChild(label);
    return input;
}

function createSimpleRangeUI(text, min, max, step, svgNode, attr) {
    var value = svgNode.getAttribute(attr);
    var input = createRangeUI(text, min, max, value, step);
    input.onchange = function() {
        svgNode.setAttribute(attr, input.value);
    };
}

function createSimpleColorPickerUI(text, svgNode, attr) {
    var value = svgNode.getAttribute(attr);
    var input = createColorPickerUI(text, value);
    input.onchange = function() {
        svgNode.setAttribute(attr, input.value);
    };
}

function createSelectUI(text, options) {
    var input = document.createElement("select");
    for (var i = 0; i < options.length; ++i) {
        var o = document.createElement("option");
        o.innerHTML = options[i];
        o.value = options[i];
        input.appendChild(o);
    }
    form.appendChild(input);
    var label = document.createElement("span");
    label.innerHTML = text;
    form.appendChild(label);
    return input;
}

function createSimpleSelectUI(text, options, svgNode, attr) {
    var select = createSelectUI(text, options);
    select.value = svgNode.getAttribute(attr);
    select.onchange = function() {
        svgNode.setAttribute(attr, select.value);
    };
}

function createCheckboxUI(text, checked) {
    var input = document.createElement("input");
    input.type = "checkbox";
    input.checked = checked;
    form.appendChild(input);
    var label = document.createElement("span");
    label.innerHTML = text;
    form.appendChild(label);
    return input;
}

function createRangePairUI(xtext, ytext, min, max, step, svgX, svgY) {
    var inputX = createRangeUI(xtext, min, max, svgX.baseVal, step);
    var inputY = createRangeUI(ytext, min, max, svgY.baseVal, step);
    var locked = createCheckboxUI("Locked", true);
    inputX.onchange = function(event) {
        if (locked.checked) inputY.value = inputX.value;
        svgX.baseVal = inputX.value;
        svgY.baseVal = inputY.value;
    };
    inputY.onchange = function(event) {
        if (locked.checked) inputX.value = inputY.value;
        svgX.baseVal = inputX.value;
        svgY.baseVal = inputY.value;
    };
}

function isBefore(node, reference) {
    for (node = node.nextSibling; node !== null; node = node.nextSibling)
        if (node == reference) return true;
    return false;
}

schematic.onCreateNode = function(node, shelfNode) {
    node.svgNode = document.createElementNS(svgns, shelfNode.svgNodeName);
    node.svgNode.id = node.id;
    if (shelfNode.onCreateNode) shelfNode.onCreateNode(node);
    f1.insertBefore(node.svgNode, f1.firstChild);
};

schematic.onSelect = function(node) {
    while (form.hasChildNodes()) form.removeChild(form.lastChild);
    if (node && node.onSelect) node.onSelect();
};

schematic.onLink = function(output, input) {
    var resultName = output.node.id;
    if (!output.node.svgNode) {
        if (input.node.svgNode)
            input.node.svgNode.setAttribute(input.id, "SourceGraphic");
    } else if (!input.node.svgNode) {
        f1.appendChild(output.node.svgNode);
    } else {
        if (isBefore(input.node.svgNode, output.node.svgNode))
            f1.insertBefore(input.node.svgNode, output.node.svgNode.nextSibling);
        output.node.svgNode.setAttribute("result", resultName);
        input.node.svgNode.setAttribute(input.id, resultName);
    }
};

function addShelfNode(id, svgNodeName, inputs) {
  var shelfNode = schematic.addShelfNode(id, inputs);
  shelfNode.svgNodeName = svgNodeName ? svgNodeName : "fe" + id;
  return shelfNode;
}

var s = addShelfNode("Blend", "feBlend", [ "in", "in2" ]);
s.onCreateNode = function(node) {
    node.svgNode.setAttribute("mode", "normal");
    node.onSelect = function() {
        createSimpleSelectUI("mode", ["normal", "multiply", "screen", "darken", "lighten"], node.svgNode, "mode");
    };
};
s = addShelfNode("Blur", "feGaussianBlur", [ "in" ]);
s.onCreateNode = function(node) {
  node.svgNode.stdDeviationX.baseVal = 10;
  node.svgNode.stdDeviationY.baseVal = 10;
  node.onSelect = function() {
    createRangePairUI("X blur", "Y blur", 0, 100, 1,
      node.svgNode.stdDeviationX, node.svgNode.stdDeviationY);
  };
};
s = addShelfNode("ColorMatrix", "feColorMatrix", [ "in" ]);
s = addShelfNode("ComponentTransfer", "feComponentTransfer", [ "in" ]);
s.onCreateNode = function(node) {
  function initComponent(id) {
    var func = document.createElementNS(svgns, "feFunc" + id);
    func.setAttribute("type", "discrete");
    func.setAttribute("tableValues", [0, 32, 64, 128, 192, 255]);
    node.svgNode.appendChild(func);
  }
  initComponent("R");
  initComponent("G");
  initComponent("B");
  initComponent("A");
};
s = addShelfNode("Composite", "feComposite", [ "in", "in2" ]);
s.onCreateNode = function(node) {
    node.svgNode.setAttribute("operator", "over");
    node.onSelect = function() {
        createSimpleSelectUI("operator", ["over", "in", "out", "atop", "xor", "arithmetic"], node.svgNode, "operator");
    };
};
s = addShelfNode("ConvolveMatrix", "feConvolveMatrix", [ "in"] );
s = addShelfNode("DiffuseLighting", "feDiffuseLighting", [ "in" ]);
s = addShelfNode("DisplacementMap", "feDisplacementMap", [ "in", "in2" ]);
s.onCreateNode = function(node) {
  node.svgNode.xChannelSelector.baseVal = SVGFEDisplacementMapElement.SVG_CHANNEL_R;
  node.svgNode.yChannelSelector.baseVal = SVGFEDisplacementMapElement.SVG_CHANNEL_G;
  node.svgNode.scale.baseVal = 50;
};
s = addShelfNode("Flood", "feFlood", []);
s.onCreateNode = function(node) {
    node.svgNode.setAttribute("flood-color", "#FF0000");
    node.svgNode.setAttribute("flood-opacity", "0.5");
    node.onSelect = function() {
        createSimpleRangeUI("Opacity", 0, 1, 0.01, node.svgNode, "flood-opacity");
        createSimpleColorPickerUI("Color", node.svgNode, "flood-color");
    };
};

s = addShelfNode("Image", "feImage", []);
s = addShelfNode("Merge", "feMerge", []);
s = addShelfNode("Morphology", "feMorphology", [ "in" ]);
s.onCreateNode = function(node) {
    node.svgNode.radiusX.baseVal = node.svgNode.radiusY.baseVal = 5;
    node.svgNode.setAttribute("operator", "dilate");
    node.onSelect = function() {
        createRangePairUI("X radius", "Y radius", 0, 50, 1,
            node.svgNode.radiusX, node.svgNode.radiusY);
        createSimpleSelectUI("operator", ["dilate", "erode"], node.svgNode, "operator");
    };
};
s = addShelfNode("Offset", "feOffset", [ "in" ]);
s.onCreateNode = function(node) {
    node.svgNode.dx.baseVal = node.svgNode.dy.baseVal = 200; 
    node.onSelect = function() {
        createRangePairUI("X offset", "Y offset", 0, 1000, 1,
            node.svgNode.dx, node.svgNode.dy);
    };
};
s = addShelfNode("Opacity", "feColorMatrix", [ "in" ]);
s.onCreateNode = function(node) {
    node.svgNode.type="matrix";
    node.svgNode.setAttribute("values", "1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.5 0");
    node.onSelect = function() {
        var value = node.svgNode.values.baseVal.getItem(18).value;
        var input = createRangeUI("Opacity", 0, 1, value, 0.01);
        input.onchange = function(value) {
            node.svgNode.setAttribute("values", "1 0 0 0 0,  0 1 0 0 0,  0 0 1 0 0,  0 0 0 " + input.value + " 0");
        };
    };
};
s = addShelfNode("SpecularLighting", "feSpecularLighting", [ "in" ]);
s = addShelfNode("Tile", "feTile", [ "in" ]);
s = addShelfNode("Turbulence", "feTurbulence", []);
var sourceGraphic = new Node("SourceGraphic", 150, 0, "#008000", "#00C000", [], ["result"]);
var output = new Node("Output", 50, 300, "#008000", "#00C000", ["in"], []);
schematic.addNode(sourceGraphic);
schematic.addNode(output);
schematic.link(sourceGraphic.outputs[0], output.inputs[0]);
schematic.invalidate();
</script>
</html>
