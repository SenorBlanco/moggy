<!doctype html>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<html>
<head>
<title>Moggy, the Interweb Transmogrifier</title>
</head>
<svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" version="1.1" color-interpolation-filters="sRGB" id="svgDoc">
  <defs>
    <filter id="f1"></filter>
  </defs>
</svg>
<video autoplay loop style="-webkit-filter: url(#f1); filter: url(#f1); position: absolute;">
<source src="octopus.mp4"></source>
<source src="octopus.ogv"></source>
</video>
<canvas width="600" height="800" id="schemCanvas" style="position: absolute; right: 0px;"></canvas>
<form id="form" style="position: absolute; bottom: 0px;">
</form>
<script src="schematic.js"></script>
<script>
var f1 = document.getElementById("f1");
var svgDocument = document.getElementById("svgDoc");
var form = document.getElementById("form");
var canvas = document.getElementById("schemCanvas");
var ctx = canvas.getContext("2d");
var schematic = new Schematic(canvas.width, canvas.height);
canvas.onmousemove = canvas.ontouchmove = function(event) { schematic.onMouseMove(event.pageX - canvas.offsetLeft, event.pageY - canvas.offsetTop); };
canvas.onmousedown = canvas.ontouchstart = function(event) { schematic.onMouseDown(event.pageX - canvas.offsetLeft, event.pageY - canvas.offsetTop); }
canvas.onmouseup = canvas.ontouchend = function(event) { schematic.onMouseUp(event.pageX - canvas.offsetLeft, event.pageY - canvas.offsetTop); }
var lastTouch;
canvas.addEventListener('touchmove', function(event) {
  if (event.targetTouches.length == 1) {
    lastTouch = event.targetTouches[0];
    schematic.onMouseMove(event.targetTouches[0].pageX - canvas.offsetLeft,
                          event.targetTouches[0].pageY - canvas.offsetTop);
  }
});
canvas.addEventListener('touchstart', function(event) {
  if (event.targetTouches.length == 1) {
    lastTouch = event.targetTouches[0];
    schematic.onMouseDown(lastTouch.pageX - canvas.offsetLeft,
                          lastTouch.pageY - canvas.offsetTop);
  }
});
canvas.addEventListener('touchend', function(event) {
  schematic.onMouseUp(lastTouch.pageX - canvas.offsetLeft,
                      lastTouch.pageY - canvas.offsetTop);
});
schematic.onInvalidate = function() {
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    schematic.draw(ctx);
}

function appendRangeUI(name, min, max, value, step) {
    var input = document.createElement("input");
    input.type = "range";
    input.name = name;
    input.min = min;
    input.max = max;
    input.value = value;
    input.step = step;
    form.appendChild(input);
    return input;
}

function isBefore(node, reference) {
    for (node = node.nextSibling; node != null; node = node.nextSibling)
        if (node == reference) return true;
    return false;
}

schematic.onCreateNode = function(node, shelfNode) {
    var svgns = "http://www.w3.org/2000/svg";
    node.svgNode = document.createElementNS(svgns, shelfNode.svgNodeName);
    node.svgNode.id = node.id;
    if (shelfNode.onCreateNode) shelfNode.onCreateNode(node);
    f1.insertBefore(node.svgNode, f1.firstChild);
}

schematic.onSelect = function(node) {
    while (form.hasChildNodes()) form.removeChild(form.lastChild);
    if (node && node.onSelect) node.onSelect();
}

schematic.onLink = function(output, input) {
    var resultName = output.node.id;
    if (!output.node.svgNode) {
        if (input.node.svgNode)
            input.node.svgNode.setAttribute(input.id, "SourceGraphic");
    } else if (!input.node.svgNode) {
        f1.appendChild(output.node.svgNode);
    } else {
        if (!isBefore(output.node.svgNode, input.node.svgNode))
            f1.insertBefore(output.node.svgNode, input.node.svgNode);
        output.node.svgNode.setAttribute("result", resultName);
        input.node.svgNode.setAttribute(input.id, resultName);
    }
}

function addShelfNode(id, svgNodeName, inputs) {
  var shelfNode = schematic.addShelfNode(id, inputs);
  shelfNode.svgNodeName = svgNodeName ? svgNodeName : "fe" + id;
  return shelfNode;
}

var s = addShelfNode("Blend", "feBlend", [ "in", "in2" ]);
s = addShelfNode("Blur", "feGaussianBlur", [ "in" ]);
s.onCreateNode = function(node) {
  node.svgNode.stdDeviationX.baseVal = 10;
  node.svgNode.stdDeviationY.baseVal = 10;
  node.onSelect = function() {
      var blurX = appendRangeUI("blurX", 0, 100, node.svgNode.stdDeviationX.baseVal, 1);
      var blurY = appendRangeUI("blurY", 0, 100, node.svgNode.stdDeviationY.baseVal, 1);
      blurX.onchange = function(event) {
          node.svgNode.stdDeviationX.baseVal = blurX.value;
      }
      blurY.onchange = function(event) {
          node.svgNode.stdDeviationY.baseVal = blurY.value;
      }
  }
}
s = addShelfNode("ColorMatrix", "feColorMatrix", [ "in" ]);
s = addShelfNode("ComponentTransfer", "feComponentTransfer", [ "in" ]);
s.onCreateNode = function(node) {
  function initComponent(id) {
    var svgns = "http://www.w3.org/2000/svg";
    var func = document.createElementNS(svgns, "feFunc" + id);
    func.setAttribute("type", "discrete");
    func.setAttribute("tableValues", [0, 32, 64, 128, 192, 255]);
    node.svgNode.appendChild(func);
  }
  initComponent("R");
  initComponent("G");
  initComponent("B");
  initComponent("A");
}
s = addShelfNode("Composite", "feComposite", [ "in", "in2" ]);
s.onCreateNode = function(node) {
  node.onSelect = function() {
  }
}
s = addShelfNode("ConvolveMatrix", "feConvolveMatrix", [ "in"] );
s = addShelfNode("DiffuseLighting", "feDiffuseLighting", [ "in" ]);
s = addShelfNode("DisplacementMap", "feDisplacementMap", [ "in", "in2" ]);
s.onCreateNode = function(node) {
  node.svgNode.xChannelSelector.baseVal = SVGFEDisplacementMapElement.SVG_CHANNEL_R;
  node.svgNode.yChannelSelector.baseVal = SVGFEDisplacementMapElement.SVG_CHANNEL_G;
  node.svgNode.scale.baseVal = 50;
}
s = addShelfNode("Flood", "feFlood", []);
s = addShelfNode("Image", "feImage", []);
s = addShelfNode("Merge", "feMerge", []);
s = addShelfNode("Morphology", "feMorphology", [ "in" ]);
s.onCreateNode = function(node) {
    node.svgNode.radiusX.baseVal = svgNode.radiusY.baseVal = 5;
}
s = addShelfNode("Offset", "feOffset", [ "in" ]);
s.onCreateNode = function(node) {
    node.svgNode.dx.baseVal = node.svgNode.dy.baseVal = 200; 
}
s = addShelfNode("Opacity", "feColorMatrix", [ "in" ]);
s.onCreateNode = function(node) {
    node.svgNode.type="matrix";
    node.svgNode.setAttribute("values", "1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.5 0");
    node.onSelect = function() {
        var input = appendRangeUI("opacity", 0, 1, node.svgNode.values[18], 0.01);
        input.onchange = function(value) {
            node.svgNode.setAttribute("values", "1 0 0 0 0,  0 1 0 0 0,  0 0 1 0 0,  0 0 0 " + input.value + " 0");
        }
    }
}
s = addShelfNode("SpecularLighting", "feSpecularLighting", [ "in" ]);
s = addShelfNode("Tile", "feTile", [ "in" ]);
s = addShelfNode("Turbulence", "feTurbulence", []);
var sourceGraphic = new Node("SourceGraphic", 150, 0, "#008000", "#00C000", [], ["result"]);
var output = new Node("Output", 50, 300, "#008000", "#00C000", ["in"], []);
schematic.addNode(sourceGraphic);
schematic.addNode(output);
schematic.link(sourceGraphic.outputs[0], output.inputs[0]);
schematic.invalidate();
</script>
</html>
